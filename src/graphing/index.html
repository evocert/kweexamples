<!DOCTYPE html>
<html lang="en-US">
	<head>
		<meta charset="utf-8">
		<style>
*{

overflow:hidden!important;
	caret-color:#FF0000;
}
html,body{
	background:#000000;
	color:#00FF00;
	font-family:monospace;
}
.container{
	padding:8px;
}
textarea{
	background:#000000;
	color:#00FF00;
	width:100%;
	border:unset;
	background:#004400;
	margin:0px;
	padding:0px;
}
select,button{
	color:#00FF00;
	border:2px solid #008800;
	border-radius:4px;
	padding:8px;
	background:#004400;
}
select{
	font-size: 17px;
	font-weight: bold;
}
#out,#src,#prg{
	background:#000000;
	color:#00FF00;
	white-space:pre;
	background:#004400;
	overflow:scroll;
}
#out{
	white-space:nowrap;
	white-space:pre;
}
textarea:focus, input:focus, button:focus, select:focus{
	outline: none;
	background:#006600!important;
}
.error{
	background:#8e1414;
}
.progress{
	background:#000000;
	color:#00FF00;
	background:#008800;
	padding:8px;
	border-radius:8px;
	position:fixed;
	top:50%;
	left:50%;
	width:128px;
	height:64px;
	margin-top:-32px;
	margin-left:-64px;
	text-align:center;
	display: table; 
}
.progress>div{
	font-size:16px;
	background:#004400;
	display: table-cell; 
	vertical-align: middle; 
	text-align: center; 
}

		
		</style>
		<script src="/require.js"></script>
		<script src="./js/require.conf.js"></script>
	</head>
	<body>
		<div class="container">
			<div>
				<button id="run_srv" class="alt-j" tooltip="Alt-Q" style="with:100%;background:#004400;font-size:16px;font-weight:bold;">Run Srv <sup>[alt-j]</sup></button>
				<button id="run_cli" class="alt-k" tooltip="Alt-W" style="with:100%;background:#004400;font-size:16px;font-weight:bold;">Run Cli <sup>[alt-k]</sup></button>
				<button id="vkeys" class="alt-k" tooltip="Alt-R" style="with:100%;background:#004400;font-size:16px;font-weight:bold;">Vi-keys <sup>[alt-k]</sup></button>
				<button id="reset" class="alt-q" tooltip="Alt-Q" style="with:100%;background:#004400;font-size:16px;font-weight:bold;">Reset<sup>[alt-q]</sup></button>
				<button id="save" class="alt-w" tooltip="Alt-W" style="with:100%;background:#004400;font-size:16px;font-weight:bold;">Save<sup>[alt-w]</sup></button>
				<select id="sample">
					<option value="test0">test0</option>
					<option value="test1">test1</option>
					<option value="test2">test2</option>
					<option value="test3">test3</option>
					<option value="test4">test4</option>
				</select>
				<span style="float:right;font-size:22px;">SRV/CLI Executor</span>
			</div><br/>


			<div style="display:flex;">
				<div style="width:50%;">
					<div style="with:100%;background:#006600;font-size:16px;font-weight:bold;">SRV<sup>[alt-1]</sup></div>
					<textarea spellcheck="false" id="srv" rows="10" class="alt-1"></textarea><br/>
				</div>
				<div style="width:50%;">
					<div style="with:100%;background:#006600;font-size:16px;font-weight:bold;">CLI<sup>[alt-2]</sup></div>
					<textarea spellcheck="false" id="cli" rows="10" class="alt-2"></textarea><br/>
				</div>
			</div>
			<div style="">
				<div style="with:100%;background:#006600;font-size:16px;font-weight:bold;">LIB<sup>[alt-3]</sup></div>
				<textarea spellcheck="false" id="lib" rows="20" class="alt-3"></textarea><br/>
			</div>
			<div>
				<div style="with:100%;background:#006600;font-size:16px;font-weight:bold;">OUT:</div>
				<div id="out"></div>
			</div>
		</div>

		<script>
			require([
				"module",
				"./api/lib/storage.js",
				"/jquery.js",
			],function(
				module,
				storage,
				_jq
			){
var sf=new storage.StorageFactory();
var s=sf.create({k:"code"});
window.s=s;

				$(document).on("keydown",function(e){
					var id=new Date().getTime();
					if(e.ctrlKey&&!e.altKey&&e.key.length==1){
						//e.stopPropagation();
						//e.preventDefault();
						$("."+"ctrl-"+e.key).click();
						if($("."+"ctrl-"+e.key).length==0)return;
						if(($("."+"ctrl-"+e.key)[0].type=="textarea"||$("."+"alt-"+e.key)[0].type=="input")||(e.target.type!="textarea"&&e.target.type=="input"))
						$("."+"ctrl-"+e.key).focus();
					}
					if(!e.ctrlKey&&e.altKey&&e.key.length==1){
						//e.stopPropagation();
						//e.preventDefault();
						$("."+"alt-"+e.key).click();
						if($("."+"alt-"+e.key).length==0)return;
						if(($("."+"alt-"+e.key)[0].type=="textarea"||$("."+"alt-"+e.key)[0].type=="input")||(e.target.type!="textarea"&&e.target.type=="input"))
						$("."+"alt-"+e.key).focus();
					}
					if(e.ctrlKey&&e.altKey&&e.key.length==1){
						//e.stopPropagation();
						//e.preventDefault();
						$("."+"ctrl-alt-"+e.key).click();
						if($("."+"ctrl-alt"+e.key).length==0)return;
						if(($("."+"ctrl-alt-"+e.key)[0].type=="textarea"||$("."+"alt-"+e.key)[0].type=="input")||(e.target.type!="textarea"&&e.target.type=="input"))
						$("."+"ctrl-alt-"+e.key).focus();
					}
				});
				function mkprogress(msg,timeout){
					var node=$("<div/>").addClass("progress");
					node.append(
						$("<div/>").text(typeof(msg)=="undefined"?"...":msg)
					);
					$("body").append(node);
					if(typeof(timeout)=="number"&&timeout>0){
						window.setTimeout(function(){node.remove()}.bind(this),timeout);
					}
					return node;
				};
				$("#run_srv").click(function(){
					var progress3=mkprogress("Running...",100);
					var src="";
					src+=$("#lib").val();
					src+="\n";
					src+=$("#srv").val()
					$.ajax({
						type: 'POST',
						headers:{
							"Content-Type":"application/json"
						},
						url: '/kweexamples/src/graphing/api/?cmd=exec',
						data:src,//$("#srv").val(),
						complete: function(r){
							if(typeof(r.responseJSON)!="undefined"){
								$("#out").text(JSON.stringify(r.responseJSON,0,2));
							}else{
								$("#out").text(JSON.stringify(r.responseText));
							}
						}
					});
				});
				$("#run_cli").click(function(){
					var progress3=mkprogress("Running...",100);
					var ret;
					try{
						var src="";
						src+=$("#lib").val();
						src+="\n";
						src+=$("#cli").val()
						ret=eval(src);
					}catch(e){
						ret=e.toString();
					}
					$("#out").text(JSON.stringify(ret,0,2));
				});
				$("#sample").on("change",function(){
					loadSrc(this.value)
				});
				function loadlib(){
					if(typeof(s.get("lib"))!="undefined"){
						$("#lib").val(s.get("lib"));
						return;
					}
					//load lib
					$.ajax({
						method:"GET",
						url:"./res/storage.js",
						success:function(r){
							s.set("lib",r);
							$("#lib").val(r);
						}.bind(this),
						error:function(e){
							progress.remove();
							alert(JSON.stringify(r));
						}.bind(this)
					});
				}
				function loadSrc(path){
					if(typeof(s.get("srv"))!="undefined"&&
					   typeof(s.get("cli"))!="undefined"
					){
						$("#srv").val(s.get("srv"));
						$("#cli").val(s.get("cli"));
						return;
					}
					var progress=mkprogress("Loading src...");
					$.ajax({
						method:"GET",
						url:"./res/"+path+".js",
						success:function(r){
							s.init("srv",r);
							s.init("cli",r);
							progress.remove();
							$("#srv").val(r);
							$("#cli").val(r);
						}.bind(this),
						error:function(e){
							progress.remove();
							alert(JSON.stringify(r));
						}.bind(this)
					});
				}
				function save(){
					mkprogress("Saving...",100);
					s.set("srv",$("#srv").val());
					s.set("cli",$("#cli").val());
					s.set("lib",$("#lib").val());
				}
				$("#save").click(function(){save();});
				$("#reset").click(function(){
					mkprogress("Resetting...",100);
					s.clear();
					loadSrc("test0");
					loadlib();
				});
				loadSrc("test0");
				loadlib();
			});
		</script>
	</body>
</html>

